  <!DOCTYPE HTML>
  <html lang="en">
  <head>
    <title>Lighthouse Moblie Connect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" href="css/jquery.mobile.css">
    <link rel="stylesheet" href="css/styles.css" />
    <style type="text/css">
 
        /* Setting body margins to 0 to have proper positioning of #container div */
        body {
            margin: 0;
        }
        /* #container div with absolute position and 100% width and height so it takes up whole window */
        #container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
 
    </style>
    <script src="js/cordova.js"></script>
    <script src="js/jquery.js"></script>
    <script type="text/javascript">
        $(document).one("mobileinit", function () {
            // Setting #container div as a jqm pageContainer
            $.mobile.pageContainer = $('#container');
            // Setting default page transition to slide
            $.mobile.defaultPageTransition = 'slide';
            $.mobile.buttonMarkup.hoverDelay = 0;
        });
    </script>
    <script src="js/jqm.page.params.js"></script>
    <script src="js/jquery.mobile.js"></script>

    <script>
      var serviceLocation = "http://m.go2lighthouse.org/services/",            
          db       = window.openDatabase("LCCMobile", "1.0", "LCCMobile", 5000000),
          eventId  = 0,                                                   
          noticeId = 0,                                                                                                          
          prayerId = 0;   

      $(function(){
        onLoad();
      });

      function onLoad(){
        document.addEventListener("deviceready", onDeviceReady, true);  
      }

      function onDeviceReady(){
          alert('deviceReady');
          $.mobile.loading('show');
          db.transaction(setupDB, errorCB);
          setupPrayers();
          setupNotices();
          setupEvents();
          db.transaction(getChurchEvents, errorCB, successCB);
      }
      
      $(document).bind("pagebeforechange", function( event, data ) {
        $.mobile.pageData = (data && data.options && data.options.pageData)
            ? data.options.pageData
            : null;
      });

      // Prayers
      $('#prayerListPage').live('pagebeforeshow', function(e) {
          $.mobile.loading('show');
          db.transaction(getPrayers, errorCB);
      });

      $('#prayerDetailsPage').live('pagebeforeshow', function(e) {
        prayerId = $.mobile.pageData.id;
        db.transaction(getPrayer, errorCB);
      });

      function getPrayer(tx) {
        tx.executeSql('SELECT * FROM prayers WHERE id = ?', [prayerId], prayer, errorCB);
      }

      function prayer(tx, results){
        $('#prayerTitle').html(results.rows.item(0).title);
        $('#prayerDescription').html(results.rows.item(0).request);
        $('#prayerDate').html(results.rows.item(0).date);
      }
      function getPrayers(tx) {
        tx.executeSql('SELECT * FROM prayers', [], getPrayerRequests);
      }

      function getPrayerRequests(tx, results) {
        var prayerList = $('#prayerList');
        prayerList.empty();
        for(var i = 0; i < results.rows.length; i++){
          prayerList.append('<li><a href="#prayerDetailsPage?id=' + results.rows.item(i).id + '">' +
            '<h3>' + results.rows.item(i).title + '</h3>' +
            '</a></li>');
          $.mobile.loading('hide');
          prayerList.listview('refresh');
        }
      }
      // End Prayers

      // Notices
      $('#noticeListPage').live('pagebeforeshow', function(e) {
          $.mobile.loading('show');
          db.transaction(getChurchNotices, errorCB);
      });

      $('#noticeDetailsPage').live('pagebeforeshow', function(event) {
        noticeId = $.mobile.pageData.id;
        db.transaction(getChurchNotice, errorCB);
      });

      function getChurchNotice(tx) {
        tx.executeSql('SELECT * FROM notices WHERE id = ?', [noticeId], churchNotice, errorCB);
      }

      function churchNotice(tx, results){
        $('#noticeTitle').html(results.rows.item(0).title);
        $('#noticeDescription').html(results.rows.item(0).description + '<br /><br />');
      }
      function getChurchNotices(tx) {
        tx.executeSql('SELECT * FROM notices', [], churchNotices);
      }

      function churchNotices(tx, results) {
        var noticeList = $('#noticeList');
        noticeList.empty();
        for(var i = 0; i < results.rows.length; i++){
          noticeList.append('<li><a href="#noticeDetailsPage?id=' + results.rows.item(i).id + '">' +
            '<h3>' + results.rows.item(i).title + '</h3>' +
            '</a></li>');
          $.mobile.loading('hide');
          noticeList.listview('refresh');
        }
      }
      // End Notices

      // Events
      $('#eventDetailsPage').live('pagebeforeshow', function(e) {
        eventId = $.mobile.pageData.id;
        db.transaction(churchEvent, errorCB);
      });

      function churchEvent(tx) {
        tx.executeSql('SELECT * FROM events WHERE id = ?', [eventId], getChurchEvent, errorCB);
      }

      function getChurchEvent(tx, results){
        $('#eventTitle').html(results.rows.item(0).title);
        $('#eventStartDateTime').html('<b>Date/Time:</b><br />' + results.rows.item(0).date + '<br /><br />');
        $('#eventVenue').html('<b>Location:</b><br />' + results.rows.item(0).venue + '<br /><br />');
        $('#eventCategory').html('<b>Category:</b><br />' + results.rows.item(0).catname + '<br /><br />');
        $('#eventDescription').html(results.rows.item(0).description);
      }

      function getChurchEvents(tx) {
        tx.executeSql('SELECT * FROM events', [], churchEvents);
      }

      function churchEvents(tx, results) {
        var eventList = $('#eventList');
        eventList.empty();
        for(var i = 0; i < results.rows.length; i++){
          eventList.append('<li><a href="#eventDetailsPage?id=' + results.rows.item(i).id + '">' +
            '<h3>' + results.rows.item(i).title + '</h3>' +
            '<h4>Date/Time: ' + results.rows.item(i).date + '</h4>' +
            '</a></li>');
        }
        $.mobile.loading('hide');
        eventList.listview('refresh');
      }
      // End Events
      
      // PopulateDB
      function setupDB(tx){
          tx.executeSql("DROP TABLE IF EXISTS prayers");
          tx.executeSql("DROP TABLE IF EXISTS notices");
          tx.executeSql("DROP TABLE IF EXISTS events");           
            
          tx.executeSql("CREATE TABLE IF NOT EXISTS prayers(id INTEGER PRIMARY KEY,title,request,date)");
          tx.executeSql("CREATE TABLE IF NOT EXISTS notices(id INTEGER PRIMARY KEY,title,description)");
          tx.executeSql("CREATE TABLE IF NOT EXISTS events(id INTEGER PRIMARY KEY,venue,catname,date,title,description)");
      }

      function setupPrayers(){
        $.ajax({
          type:"POST",
          dataType: "JSON",
          url: serviceLocation + 'getprayerrequests.php', 
          async: false,
          success:function(data){
            var prayers = data.items;
            $.each(prayers, function(index, prayer){
                  var id    = index+1,
                    title   = prayer.title,
                    request = prayer.request,
                    date    = prayer.date;

                title = title.replace(/\\/g, '');
                title = title.replace(/\'/g, '');
                request = request.replace(/\\/g, '');
                request = request.replace(/\'/g, '');

                db.transaction(function(tx){
                  tx.executeSql("INSERT INTO prayers (id, title, request, date) VALUES ("+id+", '"+title+"', '"+request+"', '"+date+"')")
                },errorCB,successCB);
            });
          }
        });
      }

      function setupNotices(){

        $.ajax({
          type:"POST",
          dataType: "JSON",
          url: serviceLocation + 'getnotices.php', 
          async: false,
          success:function(data){
            var notices = data.items;
            $.each(notices, function(index, notice){
              var title         = notice.title,
                  id            = index+1,
                  description   = notice.description;

                  description = description.replace(/\<p\>/g, '');
                  description = description.replace(/\<\/p\>/g, '');

              db.transaction(function(tx){
                tx.executeSql("INSERT INTO notices (id, title,description) VALUES ("+id+", '"+title+"','"+description+"')")
              },errorCB,successCB);
            });
          }
        });

      }
      function setupEvents(tx){
         $.ajax({
          type:"POST",
          dataType: "JSON",
          url: serviceLocation + 'getevents.php', 
          async: false,
          success:function(data){
            var events = data.items;
            $.each(events, function(index, event){
              var title = event.title,
                  description = event.datdescription,
                  id = index + 1,
                  venue = event.venue,
                  date = '',
                  catname = event.catname;

                  if(event.enddates){
                    date = event.dates + ' ' + event.times + ' - ' + event.enddates + ' ' + event.endtimes;
                  } else {
                    date = event.dates + ' ' + event.times;
                  }

                  description = description.replace(/\<p\>/g, '');
                  description = description.replace(/\<\/p\>/g, '');
  
              db.transaction(function(tx){
                tx.executeSql('INSERT INTO events (id,description, title,date,venue,catname) VALUES ("'+id+'","'+description+'","'+title+'","'+date+'","'+venue+'","'+catname+'")')
              },errorCB,successCB);
            });
          }
        });
      }
      
      // Callback for DB population error
      function errorCB(err) {
        alert("Error processing SQL: "+err.code);
        console.log(err);
        return true;
      }
      // Callback for DB population success
      function successCB(){
        // Success
      }


    </script>
  </head>

  <body>
  <div id="container">
  <div id="eventListPage" data-role="page" data-theme="b" data-content-theme="c" data-add-back-btn="false">

    <div data-role="content">
      <ul id="eventList" data-role="listview" data-filter="true"></ul>
    </div>    

   <div data-role="footer" data-position="fixed">
    <div data-role="navbar" data-theme="b">
      <ul style="display:block; height: 60px;">
        <li><a href="#eventListPage" data-role="button" data-theme="b" data-icon="grid">Events</a></li>
        <li><a href="#prayerListPage" data-role="button" data-theme="b" data-icon="star">Prayers</a></li>
        <li><a href="#noticeListPage" data-role="button" data-theme="b" data-icon="alert">Alerts</a></li>
      </ul>
    </div>
  </div>
  </div> <!-- eventListPage -->

  <div id="eventDetailsPage" data-role="page" data-theme="b" data-content-theme="c"  data-add-back-btn="false">
    <div data-role="header">
     <a data-rel="back">Back</a><h1></h1>
    </div>

    <div data-role="content"> 
      <br />
      <div id="eventDetails">
       <h3 id="eventTitle"></h3>
       <p id="eventStartDateTime"></p>
       <p id="eventEndDateTime"></p>
       <p id="eventVenue"></p>
       <p id="eventCategory"></p>
       <p id="eventDescription"></p>
      </div>

      <ul id="actionList" data-role="listview" data-inset="true"></ul>

    </div>

    <div data-role="footer" data-position="fixed">
      <div data-role="navbar" data-theme="b">
        <ul style="display:block; height: 60px;">
          <li><a href="#eventListPage" data-role="button" data-theme="b" data-icon="grid">Events</a></li>
          <li><a href="#prayerListPage" data-role="button" data-theme="b" data-icon="star">Prayers</a></li>
          <li><a href="#noticeListPage" data-role="button" data-theme="b" data-icon="alert">Alerts</a></li>
        </ul>
      </div>
    </div>
  </div> <!-- eventDetailsPage -->

  <div id="prayerListPage" data-role="page" data-theme="b" data-content-theme="c" data-add-back-btn="false">

    <div data-role="content">
      <ul id="prayerList" data-role="listview" data-filter="true"></ul>
      </div>    

      <div data-role="footer" data-position="fixed">
      <div data-role="navbar" data-theme="b">
        <ul style="display:block; height: 60px;">
          <li><a href="#eventListPage" data-role="button" data-theme="b" data-icon="grid">Events</a></li>
          <li><a href="#prayerListPage" data-role="button" data-theme="b" data-icon="star">Prayers</a></li>
          <li><a href="#noticeListPage" data-role="button" data-theme="b" data-icon="alert">Alerts</a></li>
        </ul>
      </div>
    </div>
  </div> <!-- prayerListPage -->

  <div id="prayerDetailsPage" data-role="page" data-theme="b" data-content-theme="c" data-add-back-btn="false">

    <div data-role="header">
     <a data-rel="back">Back</a><h1></h1>
    </div>

      <div data-role="content"> 
        <br />
        <div id="prayerDetails">
         <h3 id="prayerTitle"></h3>
         <p id="prayerDescription"></p>
         <p id="prayerDate"></p>
        </div>

     </div>

     <div data-role="footer" data-position="fixed">
      <div data-role="navbar" data-theme="b">
        <ul style="display:block; height: 60px;">
          <!-- <li><a href="#landingPage" data-role="button" data-theme="b" data-icon="home">Home</a></li> -->
          <li><a href="#eventListPage" data-role="button" data-theme="b" data-icon="grid">Events</a></li>
          <li><a href="#prayerListPage" data-role="button" data-theme="b" data-icon="star">Prayers</a></li>
          <li><a href="#noticeListPage" data-role="button" data-theme="b" data-icon="alert">Alerts</a></li>
        </ul>
      </div>
    </div>
  </div><!-- prayerDetailsPage -->


  <div id="noticeListPage" data-role="page" data-theme="b" data-content-theme="c" data-add-back-btn="false">


    <div data-role="content">
      <ul id="noticeList" data-role="listview" data-filter="true"></ul>
    </div>    

    <div data-role="footer" data-position="fixed">
      <div data-role="navbar" data-theme="b">
        <ul style="display:block; height: 60px;">
          <!-- <li><a href="#landingPage" data-role="button" data-theme="b" data-icon="home">Home</a></li> -->
          <li><a href="#eventListPage" data-role="button" data-theme="b" data-icon="grid">Events</a></li>
          <li><a href="#prayerListPage" data-role="button" data-theme="b" data-icon="star">Prayers</a></li>
          <li><a href="#noticeListPage" data-role="button" data-theme="b" data-icon="alert">Alerts</a></li>
        </ul>
      </div>
    </div>
  </div> <!-- noticeListPage -->

  <div id="noticeDetailsPage" data-role="page" data-theme="b" data-content-theme="c" data-add-back-btn="false">
      <div data-role="header">
       <a data-rel="back">Back</a><h1></h1>
      </div>
      <div data-role="content"> 
        <br />
        <div id="noticeDetails">
         <h3 id="noticeTitle"></h3>
         <p id="noticeDescription"></p>
       </div>

     </div>

     <div data-role="footer" data-position="fixed">
      <div data-role="navbar" data-theme="b">
        <ul style="display:block; height: 60px;">
          <!-- <li><a href="#landingPage" data-role="button" data-theme="b" data-icon="home">Home</a></li> -->
          <li><a href="#eventListPage" data-role="button" data-theme="b" data-icon="grid">Events</a></li>
          <li><a href="#prayerListPage" data-role="button" data-theme="b" data-icon="star">Prayers</a></li>
          <li><a href="#noticeListPage" data-role="button" data-theme="b" data-icon="alert">Alerts</a></li>
        </ul>
      </div>
    </div>
  </div><!-- noticeDetailsPage -->
  </div>
  <script type="text/javascript">
    $(function(){
      $("[data-role=footer]").fixedtoolbar({ transition: "none" });
      $("[data-role=header]").fixedtoolbar({ transition: "none" });
    })
  </script>
  </body>
  </html>